<!DOCTYPE html>
<html lang="en-IE">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Create a new sync flow | smartesb-skeleton</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Create a new sync flow" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Create a new sync flow" />
<meta property="og:description" content="Create a new sync flow" />
<link rel="canonical" href="http://localhost:4000/smartesb-skeleton/samples/syncflow" />
<meta property="og:url" content="http://localhost:4000/smartesb-skeleton/samples/syncflow" />
<meta property="og:site_name" content="smartesb-skeleton" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-11-20T16:21:11+00:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/smartesb-skeleton/samples/syncflow"},"@type":"BlogPosting","url":"http://localhost:4000/smartesb-skeleton/samples/syncflow","headline":"Create a new sync flow","dateModified":"2018-11-20T16:21:11+00:00","datePublished":"2018-11-20T16:21:11+00:00","description":"Create a new sync flow","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="/smartesb-skeleton/assets/css/syntax.css?v=1f75261804c34bea5c04afb0b19411974c18d8b5">
        <link rel="stylesheet" href="/smartesb-skeleton/assets/css/timeline.css">

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    </head>
    <body>
    <nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="/smartesb-skeleton">SmartESB Skeleton</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                    <a class="nav-link" href="/smartesb-skeleton">Home <span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"> </a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Introduction
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        
                            <a  class="dropdown-item" href="/smartesb-skeleton/introduction/installation">Installation and Setup Guide</a>
                        
                            <a  class="dropdown-item" href="/smartesb-skeleton/introduction/opensource">Introduction to the Smartbox Open Source Projects</a>
                        
                            <a  class="dropdown-item" href="/smartesb-skeleton/introduction/eip">Introduction to Enterprise Integration Patterns</a>
                        
                            <a  class="dropdown-item" href="/smartesb-skeleton/introduction/esb">Introduction to Enterprise Service Bus</a>
                        
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Samples
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/samples/jsonproducer">Create a new JSON Producer</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/samples/syncflow">Create a new sync flow</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/samples/asyncflow">Create a new async flow</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/samples/workers">Set up workers to consume messages</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/samples/flowdiversion">Create a flow diversion</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/samples/broadcastflow">Create a new broadcast flow</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/samples/throttle">Throttle a flow</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/samples/freezeflows">Freeze flows</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/samples/callbackflow">Callback flow</a>
                        
                    </div>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Bundles
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/bundles/corebundle">CoreBundle</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/bundles/camelconfig">CamelConfig</a>
                        
                            <a class="dropdown-item" href="/smartesb-skeleton/bundles/frameworkbundle">FrameworkBundle</a>
                        
                    </div>
                </li>
                <a class="nav-item nav-link" href="/smartesb-skeleton/roadmap">Roadmap</a>

            </ul>
        </div>
    </nav>
    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-1">
                    <p> </p>
                </div>
                <div class="col-10">
                    <br><br><br>
                    <h1 id="create-a-new-sync-flow">Create a new sync flow</h1>

<p>The Framework Bundle allows us to specify whether our endpoint will behave in a synchronous or asynchronous manner. 
Synchronous flows expect to recieve a request, make a request and then provide a response while maintaining the initial connection. 
This is generally used in GET requests, where information is required at the time of the request. 
Specifying whether a flow is synchronous or asynchronous should be tied to the API endpoint that we expose for the entry point to the flow, however, 
in the Skeleton Bundle we are not doing this in the best manner, but instead we make this decision simply in the Controller or the Command instead of an API configuration.</p>

<p>This is “faked” somewhat in the Skeleton Bundle as we have a Symfony Command that allows us to trigger a synchronous flow, 
and also in our Controller <code class="highlighter-rouge">Controller/ApiController.php</code> we make the assumption that whenever we receive a GET request, 
this is for a synchronous flow and if we receive a POST request, that that is for an asynchronous request.
Both the Command and the Controller make a call to the <code class="highlighter-rouge">Services/RequestHandlerService.php</code> Service that handles the requests to the enpoint factory. 
This will be clarified below with code samples.</p>

<p>In the Skeleton Bundle we define our flow <code class="highlighter-rouge">Ping.xml</code> as follows:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns:camel=</span><span class="s">"http://camel.apache.org/schema/spring"</span> <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;camelContext</span> <span class="na">trace=</span><span class="s">"false"</span> <span class="na">xmlns=</span><span class="s">"http://camel.apache.org/schema/spring"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;route&gt;</span>
            <span class="nt">&lt;from</span> <span class="na">uri=</span><span class="s">"api://execute/skeleton/v0/ping"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;to</span> <span class="na">uri=</span><span class="s">"rest://remote_system_api/sendPingMessage"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/route&gt;</span>
    <span class="nt">&lt;/camelContext&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<p>This will route to our <code class="highlighter-rouge">remote_system_api</code> producer. To understand more about how to create that producer please see the documentation “Create a new JSON Producer”.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
 <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="s1">'GET'</span> <span class="o">==</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getMethod</span><span class="p">())</span> <span class="p">{</span><span class="c1">//assumed always sync for demo
</span><span class="o">....</span>
<span class="nv">$responseMessage</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$methodName</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="o">....</span>

</code></pre></div></div>
<p>Where the third parameter “false” tells the called functions that <code class="highlighter-rouge">async = false</code>.</p>

<p>The main call to the service is placed in function in the Controller called <code class="highlighter-rouge">send</code> .</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">protected</span> <span class="k">function</span> <span class="nf">send</span><span class="p">(</span><span class="nv">$methodName</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$async</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$requestHandler</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'smartesb_skeleton_request_handler'</span><span class="p">);</span>
        <span class="nv">$context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Context</span><span class="p">([</span>
            <span class="nx">Context</span><span class="o">::</span><span class="na">FLOWS_VERSION</span> <span class="o">=&gt;</span> <span class="s1">'0'</span><span class="p">,</span>
            <span class="nx">Context</span><span class="o">::</span><span class="na">TRANSACTION_ID</span> <span class="o">=&gt;</span> <span class="nb">uniqid</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
            <span class="nx">Context</span><span class="o">::</span><span class="na">ORIGINAL_FROM</span> <span class="o">=&gt;</span> <span class="s1">'api'</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="nv">$responseMessage</span> <span class="o">=</span> <span class="nv">$requestHandler</span><span class="o">-&gt;</span><span class="na">handleCall</span><span class="p">(</span>
            <span class="s1">'skeleton'</span><span class="p">,</span>
            <span class="s1">'v0'</span><span class="p">,</span>
            <span class="nv">$methodName</span><span class="p">,</span>
            <span class="nv">$data</span><span class="p">,</span>
            <span class="p">[],</span>
            <span class="nv">$context</span><span class="p">,</span>
            <span class="nv">$async</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$responseMessage</span><span class="p">;</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>In both our Command and Controller we make a call to the function <code class="highlighter-rouge">handleCall</code> in the <code class="highlighter-rouge">RequestHandlerService</code> Service.</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 
 <span class="k">public</span> <span class="k">function</span> <span class="nf">handleCall</span><span class="p">(</span>
         <span class="nv">$serviceName</span><span class="p">,</span>
         <span class="nv">$apiVersion</span><span class="p">,</span>
         <span class="nv">$methodName</span><span class="p">,</span>
         <span class="nv">$messageBody</span><span class="p">,</span>
         <span class="nv">$messageHeaders</span><span class="p">,</span>
         <span class="nv">$context</span><span class="p">,</span>
         <span class="nv">$async</span> <span class="o">=</span> <span class="kc">false</span>
     <span class="p">)</span> <span class="p">{</span>
         <span class="nv">$apiPrefix</span> <span class="o">=</span> <span class="s1">'api'</span><span class="p">;</span>
         <span class="nv">$fromUri</span> <span class="o">=</span> <span class="nv">$apiPrefix</span><span class="o">.</span><span class="s1">'://entry/'</span><span class="o">.</span><span class="nv">$serviceName</span><span class="o">.</span><span class="s1">'/'</span><span class="o">.</span><span class="nv">$apiVersion</span><span class="o">.</span><span class="s1">'/'</span><span class="o">.</span><span class="nv">$methodName</span><span class="p">;</span>
         <span class="nv">$helper</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'smartesb.helper'</span><span class="p">);</span>
         <span class="nv">$messageFactory</span> <span class="o">=</span> <span class="nv">$helper</span><span class="o">-&gt;</span><span class="na">getMessageFactory</span><span class="p">();</span>
         <span class="nv">$contextExtra</span> <span class="o">=</span> <span class="p">[];</span>
         <span class="nv">$contextExtra</span><span class="p">[</span><span class="s1">'from'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$fromUri</span><span class="p">;</span>
         <span class="nv">$priority</span> <span class="o">=</span> <span class="s1">'normal'</span><span class="p">;</span>
         <span class="nv">$contextExtra</span><span class="p">[</span><span class="s1">'api_mode'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'real'</span><span class="p">;</span>
         <span class="nv">$contextExtra</span><span class="p">[</span><span class="s1">'priority'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$priority</span><span class="p">;</span>
         <span class="nv">$context</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Context</span><span class="p">(</span><span class="nb">array_merge</span><span class="p">(</span><span class="nv">$context</span><span class="o">-&gt;</span><span class="na">toArray</span><span class="p">(),</span> <span class="nv">$contextExtra</span><span class="p">));</span>
         <span class="nv">$messageHeaders</span><span class="p">[</span><span class="nx">Message</span><span class="o">::</span><span class="na">HEADER_FROM</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$fromUri</span><span class="p">;</span>
         <span class="nv">$messageHeaders</span><span class="p">[</span><span class="s1">'api_mode'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'real'</span><span class="p">;</span>
         <span class="nv">$messageHeaders</span><span class="p">[</span><span class="s1">'async'</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$async</span> <span class="o">?</span> <span class="s1">'true'</span> <span class="o">:</span> <span class="s1">'false'</span><span class="p">;</span>
         <span class="nv">$message</span> <span class="o">=</span> <span class="nv">$messageFactory</span><span class="o">-&gt;</span><span class="na">createMessage</span><span class="p">(</span><span class="nv">$messageBody</span><span class="p">,</span> <span class="nv">$messageHeaders</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
         <span class="nv">$endpoint</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'smartesb.endpoint_factory'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">createEndpoint</span><span class="p">(</span><span class="nv">$message</span><span class="o">-&gt;</span><span class="na">getHeader</span><span class="p">(</span><span class="nx">Message</span><span class="o">::</span><span class="na">HEADER_FROM</span><span class="p">),</span> <span class="nx">EndpointFactory</span><span class="o">::</span><span class="na">MODE_CONSUME</span><span class="p">);</span>
         <span class="nv">$resultMessage</span> <span class="o">=</span> <span class="nv">$endpoint</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
 
         <span class="k">return</span> <span class="nv">$resultMessage</span><span class="p">;</span>
     <span class="p">}</span>
 
</code></pre></div></div>

<p>As you can see our default is to make a synchronous call. 
In this function we set the message header <code class="highlighter-rouge">$messageHeaders['async']</code> which will be later interpreted by the Service <code class="highlighter-rouge">smartesb.endpoint_factory</code>).</p>

<p>This same call call is made from the Symfony Command: <code class="highlighter-rouge">Command/SkeletonSendPingCommand.php</code>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$responseMessage</span> <span class="o">=</span> <span class="nv">$requestHandler</span><span class="o">-&gt;</span><span class="na">handleCall</span><span class="p">(</span>
            <span class="s1">'skeleton'</span><span class="p">,</span>
            <span class="s1">'v0'</span><span class="p">,</span>
            <span class="s1">'ping'</span><span class="p">,</span>
            <span class="nv">$pingMessage</span><span class="p">,</span>
            <span class="p">[],</span>
            <span class="nv">$context</span><span class="p">,</span>
            <span class="kc">false</span>
        <span class="p">);</span>
        
</code></pre></div></div>

<p>So, to sum up, the deciding factor between a synchronous flow and asynchronous flow is simply a message header that we set. 
This should be associated with an api configuration but currently in the Skeleton Bundle we are not doing this. 
The RequestHandlerService in the Skeleton Bundle handles the creation and preparation of the message to be passed to the Enpoint Factory.</p>

                </div>
                <div class="col-1">
                    <p> </p>
                </div>
            </div>
        </div>
    </div>
    </body>
</html>
